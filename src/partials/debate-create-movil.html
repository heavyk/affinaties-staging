<link rel='ractive' href='../partials/categories.html'>
<link rel='ractive' href='../partials/foto-upload.html'>
<link rel='ractive' href='../partials/tag-completer.html'>

<div class="square">

      <div class="row-movil">
        <!-- <categories L="{selector:'Seleccione una categorÃ­a', selected: '', show_button: true}" on-select="category" class="{{errors.d.category ? 'invalid' : ''}}" /> -->
        <select value="{{d.category}}">
          <option >Selecciona una categoria</option>
          {{#each categories}}
            <option value="{{._id}}">{{.title}}</option>
          {{/each}}
        </select>
      </div>
      <div class="row-movil">
        <tag-completer selected="{{tags}}" />
      </div>
      <div class="row-movil">
        <textarea
          placeholder="Escribe tu opinion"
          name="text"
          maxlength="2048"
          value="{{d.text}}"
          class="{{errors.d.text ? 'invalid' : ''}}">
        </textarea>
      </div>

      <div class="row-movil">
        <foto-upload icon="camera" cropped="{{cropped}}" />
      </div>
      <div class="row-button">
        <button class="button-opina" on-tap="opinar" >
          Opinar
        </button>
      </div>

</div>

<style>
.button-opina{
  background: #FF4314;
  color: #FFF;
  width: 96%;
  padding: 9px 15px;
  height: 44px;
}
.row-movil{
  width: 100%;
}
.row-button{
  width: 100%;
  position: absolute;
  bottom:20px;
}
.categories {
  position: fixed;
  z-index: 100;
  margin-top: -15px;
}

.categories-button {
  float: none;
  text-align: center;
}

.foto-crop {
  margin-left: 10px;
  width: 240px;
}

.square {
  /* margin-top: 30px; */
width: 100%;
/* margin-left: 30px; */
/* margin-right: 30px; */
margin: 0 auto;
}

.invalid {
  border: solid 1px #f00;
}

.dropzone-area {
  color: #fd270d;
  /* border: 1px solid #222; */
  /* border-color: rgba(0,0,0,.1) rgba(0,0,0,.1) rgba(0,0,0,.25); */
  border-radius: 7px;
  text-decoration: none;
  padding: 6px 14px;
  font-size: 40px;
  font-weight: 300;
  line-height: .8;
  text-align: center;
  white-space: nowrap;
  cursor: pointer;
  position: absolute;
  outline: 0;
  /* text-shadow: 0 -1px 0 rgba(0,0,0,.25); */
  /* box-shadow: inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05); */
  width: 100%;
  /*height: 50px;*/
  /* margin: 0 0 0 12px; */
  display: inline-block;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  margin: 0 auto;
  margin-bottom: 30px;
}
.dropzone-area .fa {
  padding: 50%;
}
.categories-button {
  margin-bottom: 20px;
}
</style>

<script>
let pluck = require('../lib/lodash/collection/pluck')
let Validator = require('../validator')
component.exports = {
  isolated: true,
  oninit () {
    this.set ('menu', false)
    this.set('d.pos', 2)
    this.validator = new Validator('d', {
      'text': {required: true, min: 2, max: 2048},
      'category': {required: true, type: 'id'},
      'pos': {required: true, type: 'integer', min: -2, max: 2},
      'tag': {required: false, type: 'array', max: 3},
      'foto': {required: false, type: 'id'},
    })
    this.on('category', (category) => {
      this.set('d.category', category._id)
      if (this.submitted) {
        let form = this.validator.validate(this)
        this.set('errors', form.errors)
      }
    })
    this.observe('cropped', (v) => {
      if (v && v.length) this.set('d.foto', v[0])
    })
    this.observe('tags', (tags) => {
      this.set('d.tag', pluck(tags, '_id'))
    })
    api.category.until('/', () => {
      let list = api.category.list
      let len = Math.round(list.length / 2)
      let l1 = list.slice(0, len)
      let l2 = list.slice(len)
      this.set('categories', list)
      this.set('l1', l1)
      this.set('l2', l2)
      this.set('loading', false)
    })
    this.on('opinar', (event) => {
      debugger
      if (this.get('saving')) return
      this.submitted = true

        let form = this.validator.validate(this)
        this.set('errors', form.errors)
        if (form.valid) {
          // api.debate.create(form.data, )
          // TODO spinner
          this.set('saving', true)
          api.action('debate+', form.data, (d) => {
            this.set('saving', false)
            Ractive.nexus.debate.create(d)
            this.parent.teardown()
          })
        }

    })
  },
  events: {
    tap: require('../lib/events/tap.js'),
  },
}
</script>
