<div class="tag-completer">
	<input
		type="text"
		value="{{title}}"
		placeholder="escribe los tags aquÃ­"
		on-nlSubmit="add"
		on-focus-blur="toggle-taglist"
		style="display: {{selected.length < 3 ? 'block' : 'none'}}"
		on-keyup="keyup" />
	<div class="tags" style="display: {{taglist ? 'block' : 'none'}}">
		<div class="wrapper">
			{{#list:i}}
			<div class="tag" on-click="add">
				{{title}}
			</div>
			{{/}}
			{{#if recent}}
				<div class="recent">recent</div>
				{{#recent:i}}
				<div class="tag" on-click="add">
					{{title}}
				</div>
				{{/recent}}
			{{/if}}
		</div>
	</div>
	<ul class="selected-tags">
		{{#selected:i}}
		<li class="tag" on-click="remove">
			{{title}}
		</li>
		{{/}}
	</ul>
</div>

<style>
.tag-completer {
	position: relative;
	display: inline-block;
	width: 100%;
	margin-bottom: 8px;
}
.tags {
  position: absolute;
	top: 48px;
  padding: 4px;
	background: #fff;
	border: solid 1px #dadada;
	border-radius: 5px;
	width: 100%;
}
.selected-tags {
  margin: 2px 5px;
	padding: 0;
	list-style: none;
}
.wrapper {
  height: 100%;
  overflow-y: auto;
  padding: 0;
}
.input[type="text"] {
  margin: 0;
}
.recent {
	color: #dadada;
	border-bottom: solid 1px #dadada;
}
div.tag {
  position: relative;
  margin: 0 0 2px;
  background: #f3f3f3;
  min-width: 80%;
  z-index: 1;
	cursor: pointer;
}
li.tag {
	float: left;
	padding: 4px 8px;
	margin: 4px;
	border: solid 1px #fd270d;
	border-radius: 8px;
	color: #fd270d;
	cursor: pointer;
}
</style>

<script>


function idx(tags, id, field) {
	field = field || '_id'
	for (let i = 0; i < tags.length; i++) {
		if (tags[i][field] === id) return i
	}
	return -1
}

let api = require('../api')
let assign = require('../lib/lodash/object/assign')
let uniq = require('../lib/lodash/array/uniq')
let compact = require('../lib/lodash/array/compact')
let findIndex = require('../lib/lodash/array/findIndex')
let each = require('../lib/lodash/collection/each')
component.exports = {
	isolated: true,
	onconfig () {
		let list = []
		let selected = []
		let recent = []
		// let recent = api.tag.recent
		api.local.getItem('tags:recent', (err, tags) => {
			if (err) return
			recent.push.apply(recent, uniq(tags, '_id'))
			for (let i = 0; i < tags.length; i++) {
				api.tag.insert(tags[i])
			}
		})
		this.set('selected', selected)
		this.set('list', list)
		this.set('recent', recent)
		this.on('add', (event) => {
			let i, t = assign({}, event.context)
			if (~idx(selected, t._id)) return
			if (~(i = findIndex(recent, 'title', t.title))) {
				selected.push(recent[i])
				recent.splice(i, 1)
			} else if (~(i = findIndex(list, 'title', t.title))) {
				selected.push(list[i])
			} else api.action('tag+', {title: t.title}, (tag) => {
				if (tag) {
					selected.push(tag)
					api.tag.insert(tag)
				}
			})

			this.set('title', '')
			this.find('input').blur()
		})
		this.on('remove', (event) => {
			let i, t = selected.splice(event.index.i, 1)[0]
			// remove previous occurances
			if (~(i = findIndex(recent, '_id', t._id)))
				recent.splice(i, 1)
			recent.splice(0, 0, t)
		})
		this.on('toggle-taglist', (event) => {
			setTimeout(() => {
				this.toggle('taglist')
			}, 200)
		})
		this.on('keyup', (event) => {
			console.log('TODO up, down, left, right')
			if (event.original.which === 0x20) {
				// TODO check to see if title is in the list and add it there
				this.fire('add', event)
				this.set('title', '')
			}
		})
		this.observe('title', (title) => {
			if (title && title.length > 1) {
				api.action('tag@', {title: title}, (tags) => {
					list.splice.apply(list, [0, list.length].concat(tags))
					for (let i = 0; i < tags.length; i++) {
						api.tag.insert(tags[i])
					}
				})
			}
		})
		this.once('teardown', () => {
			api.local.getItem('tags:recent', (err, _recent) => {
				let save = compact(uniq(selected.concat(_recent).concat(recent), '_id'))
				if (save.length !== save2.length) debugger
				api.local.setItem('tags:recent', save, (err) => {
					console.log('saved recent tags', save)
				})
			})
		})
	},
  events: {
    nlSubmit: require('../lib/events/nlSubmit')
  },
}
</script>
